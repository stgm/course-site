<table id="grade-table" class="table table-sm table-striped table-responsive">
	<tr>
		<th></th>

		<% if params[:status] != 'registered' %>
		<th>Participation</th>
		<% end %>

		<% @psets.each do |pset| %>
		<th>
			<%= link_to_if current_user.admin?, pset.name[0..2], publish_schedule_grades_path(schedule_slug: @selected_schedule.slug, pset_id: pset.id), method: :post, data: { confirm: "Publish all grades for this assignment?" }, title: pset.name %>
		</th>
		<% end %>
	</tr>

	<% users.each do |group, user_list|%>
		<tr>
			<th class="py-2" colspan="<%= (params[:status] != 'registered') ? '2' : '1' %>">
				<% if group %>
					<%= group.name %> &ndash;
					<%= group.grader_names %>
				<% else %>
					Groupless
				<% end %>
				(<%= user_list.size %>)
			</th>
			<% @psets.each do |pset| %>
			<th>
				<% if group %>
				<%= link_to_if current_user.admin?, pset.name[0..2], reopen_schedule_grades_path(schedule_slug: @selected_schedule.slug, pset_id: pset.id, group_id: group.id), method: :post, data: { confirm: "Re-open all grades for this assignment for this group?" }, title: pset.name, classs: 'text-light' %>
				<% else %>
				<% end %>
			</th>
			<% end %>
		</tr>
		<% user_list.each do |user| %>
			<% cache [user, :head_overview] do %>
				<tr <%= 'class=table-warning' if @show_inactive && user.stagnated? %>>
					<td>
						<%= link_to user.name, user, data: { toggle: "modal" }, target: "modal" %>
						<% if user.alarm %>
						<%= bootstrap_icon 'exclamation-triangle-fill', width: 12, height: 12 %>
						<% end %>
						<% if user.last_known_location %>
						<span aria-hidden="true" data-toggle="tooltip" title="<%= user.last_known_location %>">L</span>
						<% end %><br>
						<%= best_in_place user, :status_description, as: :input %>
					</td>

					<% if params[:status] != 'registered' %>
					<td class="bar">
						<%= user.attendance %><br>
						<%= user.hands_count %> hands,
						<%= user.hands_duration_count %> mins
					</td>
					<% end %>

					<%
					subs = user.submits.group_by(&:pset_id)
					%>

					<% @psets.each do |pset| %>
					<% grade = subs && subs[pset.id] && subs[pset.id][0].grade %>
					<td class="<%= grade_bg_type(grade.any_final_grade, grade.public?) if grade %>">
						<%= grade_button(user, pset, subs)%>
					</td>
					<% end %>
				</tr>
			<% end %>
		<% end %>
	<% end %>
</table>
